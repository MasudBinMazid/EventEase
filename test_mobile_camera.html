<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Camera Test - EventEase QR Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f3f4f6;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 32px;
        }
        
        .test-section {
            margin: 24px 0;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #374151;
        }
        
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 4px;
        }
        
        button:hover {
            background: #059669;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .status {
            margin: 12px 0;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status.info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .status.success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .status.error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }
        
        #video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 8px;
            margin: 12px auto;
            display: block;
        }
        
        #qrReader {
            margin: 12px 0;
        }
        
        .device-info {
            font-size: 12px;
            color: #6b7280;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Mobile Camera Test</h1>
        <p style="text-align: center; color: #6b7280;">Test camera functionality for QR scanning on your mobile device</p>
        
        <!-- Device Info -->
        <div class="test-section">
            <h3>üìã Device Information</h3>
            <div id="deviceInfo" class="device-info"></div>
        </div>
        
        <!-- Basic Camera Test -->
        <div class="test-section">
            <h3>üìπ Basic Camera Test</h3>
            <p>Test if your device can access the camera:</p>
            <button onclick="testBasicCamera()">Test Camera Access</button>
            <button onclick="stopBasicCamera()" disabled id="stopCameraBtn">Stop Camera</button>
            <div id="cameraStatus"></div>
            <video id="video" style="display:none;" autoplay playsinline></video>
        </div>
        
        <!-- QR Scanner Test -->
        <div class="test-section">
            <h3>üì± QR Scanner Test</h3>
            <p>Test the actual QR scanner (same as EventEase):</p>
            <button onclick="testQRScanner()">Start QR Scanner</button>
            <button onclick="stopQRScanner()" disabled id="stopQRBtn">Stop QR Scanner</button>
            <div id="qrStatus"></div>
            <div id="qrReader" style="display:none;"></div>
            <div id="scanResult"></div>
        </div>
        
        <!-- Permissions Info -->
        <div class="test-section">
            <h3>üîê Permission Status</h3>
            <button onclick="checkPermissions()">Check Camera Permission</button>
            <div id="permissionStatus"></div>
        </div>
        
        <!-- Troubleshooting -->
        <div class="test-section">
            <h3>üîß Troubleshooting Tips</h3>
            <ul style="color: #374151; line-height: 1.6;">
                <li><strong>Camera Permission:</strong> Make sure to allow camera access when prompted</li>
                <li><strong>HTTPS Required:</strong> Camera only works on HTTPS or localhost</li>
                <li><strong>Browser Support:</strong> Use Chrome, Firefox, or Safari for best results</li>
                <li><strong>Mobile Safari:</strong> May need to refresh page after first camera access</li>
                <li><strong>Multiple Cameras:</strong> Will try to use back camera first on mobile</li>
            </ul>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        let video;
        let stream;
        let html5QrcodeScanner;
        
        // Display device information
        function displayDeviceInfo() {
            const info = document.getElementById('deviceInfo');
            const userAgent = navigator.userAgent;
            const isMobile = /Mobi|Android/i.test(userAgent);
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            
            info.innerHTML = `
                <div><strong>User Agent:</strong> ${userAgent}</div>
                <div><strong>Mobile Device:</strong> ${isMobile ? 'Yes' : 'No'}</div>
                <div><strong>Secure Context (HTTPS):</strong> ${isSecure ? 'Yes' : 'No'}</div>
                <div><strong>MediaDevices API:</strong> ${navigator.mediaDevices ? 'Available' : 'Not Available'}</div>
                <div><strong>Screen Size:</strong> ${window.screen.width}x${window.screen.height}</div>
                <div><strong>Viewport:</strong> ${window.innerWidth}x${window.innerHeight}</div>
            `;
        }
        
        // Test basic camera access
        async function testBasicCamera() {
            const status = document.getElementById('cameraStatus');
            const video = document.getElementById('video');
            const stopBtn = document.getElementById('stopCameraBtn');
            
            try {
                status.innerHTML = '<div class="status info">üîÑ Requesting camera access...</div>';
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                stopBtn.disabled = false;
                
                status.innerHTML = '<div class="status success">‚úÖ Camera access successful!</div>';
                
            } catch (error) {
                console.error('Camera error:', error);
                let message = 'Failed to access camera: ' + error.message;
                
                if (error.name === 'NotAllowedError') {
                    message = 'Camera permission denied. Please allow camera access.';
                } else if (error.name === 'NotFoundError') {
                    message = 'No camera found on this device.';
                } else if (error.name === 'NotSupportedError') {
                    message = 'Camera not supported in this browser.';
                }
                
                status.innerHTML = `<div class="status error">‚ùå ${message}</div>`;
            }
        }
        
        function stopBasicCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            const video = document.getElementById('video');
            const stopBtn = document.getElementById('stopCameraBtn');
            
            video.style.display = 'none';
            video.srcObject = null;
            stopBtn.disabled = true;
            
            document.getElementById('cameraStatus').innerHTML = '<div class="status info">üìπ Camera stopped</div>';
        }
        
        // Test QR Scanner
        function testQRScanner() {
            const reader = document.getElementById('qrReader');
            const status = document.getElementById('qrStatus');
            const stopBtn = document.getElementById('stopQRBtn');
            
            reader.style.display = 'block';
            stopBtn.disabled = false;
            status.innerHTML = '<div class="status info">üîÑ Starting QR scanner...</div>';
            
            const config = {
                fps: 10,
                qrbox: function(viewfinderWidth, viewfinderHeight) {
                    let minEdgePercentage = 0.7;
                    let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                    let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                    return {
                        width: qrboxSize,
                        height: qrboxSize
                    };
                },
                aspectRatio: 1.0,
                disableFlip: false,
                videoConstraints: {
                    facingMode: { ideal: "environment" }
                }
            };
            
            html5QrcodeScanner = new Html5QrcodeScanner("qrReader", config, false);
            
            html5QrcodeScanner.render(
                (decodedText, decodedResult) => {
                    status.innerHTML = '<div class="status success">‚úÖ QR Code detected successfully!</div>';
                    document.getElementById('scanResult').innerHTML = `
                        <div class="status success">
                            <strong>Scanned Content:</strong><br>
                            <code>${decodedText}</code>
                        </div>
                    `;
                    stopQRScanner();
                },
                (error) => {
                    console.log('QR scan error (normal):', error);
                }
            );
            
            // Update status after a moment
            setTimeout(() => {
                status.innerHTML = '<div class="status success">üì± QR scanner is running. Point camera at a QR code.</div>';
            }, 2000);
        }
        
        function stopQRScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }
            
            document.getElementById('qrReader').style.display = 'none';
            document.getElementById('stopQRBtn').disabled = true;
            document.getElementById('qrStatus').innerHTML = '<div class="status info">üì± QR scanner stopped</div>';
        }
        
        // Check permissions
        async function checkPermissions() {
            const status = document.getElementById('permissionStatus');
            
            try {
                if (navigator.permissions) {
                    const permission = await navigator.permissions.query({name: 'camera'});
                    status.innerHTML = `<div class="status info">üì∑ Camera permission: <strong>${permission.state}</strong></div>`;
                } else {
                    status.innerHTML = '<div class="status info">üì∑ Permissions API not supported. Try accessing camera directly.</div>';
                }
            } catch (error) {
                status.innerHTML = `<div class="status error">‚ùå Error checking permissions: ${error.message}</div>`;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            displayDeviceInfo();
            
            // Check if we're in a secure context
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                document.body.innerHTML = `
                    <div class="container">
                        <h1>‚ö†Ô∏è HTTPS Required</h1>
                        <div class="status error">
                            Camera access requires HTTPS. Please access this page via HTTPS or localhost.
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
